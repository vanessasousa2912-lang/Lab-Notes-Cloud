<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabNotes Cloud - Protegido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        // Configuração do Tailwind para suportar modo escuro via classe
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'notepad-pro-luis-v5';

        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const editor = document.getElementById('editor');
        const noteTitle = document.getElementById('noteTitle');
        const notesList = document.getElementById('notesList');
        const saveStatus = document.getElementById('saveStatus');
        const loginInput = document.getElementById('loginInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginMessage = document.getElementById('loginMessage');

        let currentUserId = sessionStorage.getItem('luis_notepad_id') || localStorage.getItem('luis_notepad_id');
        let currentNoteId = null;
        let isTyping = false;
        let unsubscribe = null;
        let authenticatedUser = null;

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        async function startApp() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { 
                console.error("Erro Auth:", e);
            }
        }

        onAuthStateChanged(auth, (u) => {
            authenticatedUser = u;
            if (u) {
                if (currentUserId) {
                    showMainApp();
                } else {
                    showLoginScreen();
                }
            }
        });

        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
        }

        function showMainApp() {
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            syncWithCloud();
        }

        window.toggleTheme = () => {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        };

        window.togglePassword = () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
        };

        window.handleLogin = async () => {
            const id = loginInput.value.trim().toLowerCase();
            const pass = passwordInput.value.trim();

            if (!id || !pass) {
                loginMessage.innerText = "Preenche o ID e a Senha!";
                return;
            }

            loginBtn.disabled = true;
            loginBtn.innerText = "A verificar...";

            const userRef = doc(db, 'artifacts', appId, 'users', authenticatedUser.uid, 'manual_ids', id);
            const userDoc = await getDoc(userRef);

            if (userDoc.exists()) {
                if (userDoc.data().password === pass) {
                    loginSuccess(id);
                } else {
                    loginMessage.innerText = "Senha incorreta!";
                    loginBtn.disabled = false;
                    loginBtn.innerText = "Abrir Bloco";
                }
            } else {
                await setDoc(userRef, { password: pass, createdAt: serverTimestamp() });
                loginSuccess(id);
            }
        };

        function loginSuccess(id) {
            currentUserId = id;
            localStorage.setItem('luis_notepad_id', id);
            sessionStorage.setItem('luis_notepad_id', id);
            showMainApp();
        }

        function syncWithCloud() {
            if (!authenticatedUser || !currentUserId) return;
            const notesCol = collection(db, 'artifacts', appId, 'users', authenticatedUser.uid, 'manual_ids', currentUserId, 'notes');
            unsubscribe = onSnapshot(notesCol, (snapshot) => {
                const notes = [];
                snapshot.forEach(doc => { notes.push({ id: doc.id, ...doc.data() }); });
                notes.sort((a, b) => (b.lastModified?.toMillis() || 0) - (a.lastModified?.toMillis() || 0));
                updateSidebar(notes);
                if (notes.length === 0) {
                    createNewNote();
                } else if (!currentNoteId) {
                    loadNote(notes[0].id, notes[0]);
                } else if (!isTyping) {
                    const active = notes.find(n => n.id === currentNoteId);
                    if (active) {
                        if (noteTitle.value !== active.title) noteTitle.value = active.title || '';
                        if (editor.innerHTML !== active.text) editor.innerHTML = active.text || '';
                    }
                }
            }, (error) => { saveStatus.innerHTML = `<span class="text-red-500 font-bold uppercase">Erro de Sincronização</span>`; });
        }

        function updateSidebar(notes) {
            notesList.innerHTML = '';
            notes.forEach(note => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left p-3 rounded-lg mb-1 transition-all ${note.id === currentNoteId ? 'bg-indigo-50 dark:bg-indigo-900/30 border-l-4 border-indigo-500' : 'hover:bg-slate-50 dark:hover:bg-slate-800'}`;
                btn.onclick = () => loadNote(note.id, note);
                const preview = (note.text || '').replace(/<[^>]*>/g, ' ').substring(0, 30);
                btn.innerHTML = `<div class="font-bold text-slate-700 dark:text-slate-200 text-sm truncate uppercase">${note.title || 'Sem título'}</div><div class="text-[10px] text-slate-400 dark:text-slate-500 truncate">${preview || '...'}</div>`;
                notesList.appendChild(btn);
            });
        }

        function loadNote(id, data) {
            currentNoteId = id;
            noteTitle.value = data.title || '';
            editor.innerHTML = data.text || '';
        }

        window.createNewNote = async () => {
            if (!authenticatedUser || !currentUserId) return;
            const newId = "note_" + Date.now();
            currentNoteId = newId;
            const noteRef = doc(db, 'artifacts', appId, 'users', authenticatedUser.uid, 'manual_ids', currentUserId, 'notes', newId);
            try { await setDoc(noteRef, { title: 'Nova Nota', text: '', lastModified: serverTimestamp() }); noteTitle.focus(); } catch (e) { console.error(e); }
        };

        async function pushToCloud() {
            if (!authenticatedUser || !currentUserId || !currentNoteId) return;
            saveStatus.innerHTML = `<span class="text-amber-500 animate-pulse text-[10px] font-bold tracking-widest uppercase">A GUARDAR...</span>`;
            const noteRef = doc(db, 'artifacts', appId, 'users', authenticatedUser.uid, 'manual_ids', currentUserId, 'notes', currentNoteId);
            try {
                await setDoc(noteRef, { title: noteTitle.value, text: editor.innerHTML, lastModified: serverTimestamp() }, { merge: true });
                saveStatus.innerHTML = `<span class="text-emerald-500 text-[10px] font-bold italic uppercase tracking-widest">✓ NUVEM ATIVA</span>`;
            } catch (e) { saveStatus.innerHTML = `ERRO`; }
        }

        window.deleteNote = async () => {
            if (!authenticatedUser || !currentUserId || !currentNoteId || !confirm("Apagar esta nota permanentemente?")) return;
            const noteRef = doc(db, 'artifacts', appId, 'users', authenticatedUser.uid, 'manual_ids', currentUserId, 'notes', currentNoteId);
            await deleteDoc(noteRef);
            currentNoteId = null;
        };

        // Funções de Download
        window.downloadTXT = () => {
            const text = noteTitle.value + "\n\n" + editor.innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${noteTitle.value || 'nota'}.txt`;
            a.click();
        };

        window.downloadPDF = () => {
            const element = document.createElement('div');
            element.innerHTML = `<h1 style="font-size: 24pt; margin-bottom: 20px;">${noteTitle.value}</h1>` + editor.innerHTML;
            element.style.padding = "40px";
            html2pdf().from(element).save(`${noteTitle.value || 'nota'}.pdf`);
        };

        // Download DOCX (HTML para Word básico)
        window.downloadDOCX = () => {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export DOCX</title></head><body>";
            const footer = "</body></html>";
            const sourceHTML = header + `<h1>${noteTitle.value}</h1>` + editor.innerHTML + footer;
            
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = `${noteTitle.value || 'nota'}.doc`;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        };

        window.format = (cmd) => { document.execCommand(cmd, false, null); editor.focus(); };
        window.logout = () => { localStorage.clear(); sessionStorage.clear(); window.location.reload(); };

        startApp();
        editor.addEventListener('input', () => { isTyping = true; clearTimeout(window.saveTimer); window.saveTimer = setTimeout(() => { isTyping = false; pushToCloud(); }, 800); });
        noteTitle.addEventListener('input', () => { isTyping = true; clearTimeout(window.saveTimer); window.saveTimer = setTimeout(() => { isTyping = false; pushToCloud(); }, 800); });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .editor-area { outline: none; line-height: 1.8; }
        [contenteditable]:empty:before { content: "Escreve aqui as tuas ideias..."; color: #cbd5e1; font-weight: 500; }
        .dark [contenteditable]:empty:before { color: #475569; }
    </style>
</head>
<body class="h-screen bg-slate-50 dark:bg-slate-950 overflow-hidden text-slate-900 dark:text-slate-100 transition-colors duration-300">

    <!-- Ecrã de Login -->
    <div id="loginScreen" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900 p-6">
        <div class="max-w-md w-full bg-white dark:bg-slate-900 rounded-3xl p-10 shadow-2xl text-center border border-slate-200 dark:border-slate-800">
            <div class="w-16 h-16 bg-indigo-600 rounded-2xl mx-auto mb-6 flex items-center justify-center text-white shadow-lg">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
            </div>
            <h2 class="text-3xl font-extrabold text-slate-900 dark:text-white mb-2 tracking-tighter italic">LabNotes <span class="text-indigo-600">Cloud</span></h2>
            <p class="text-slate-500 dark:text-slate-400 mb-8 text-sm font-medium">Cria ou acede ao teu bloco com senha.</p>
            
            <div class="space-y-3">
                <input type="text" id="loginInput" placeholder="ID de Utilizador" 
                       class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-transparent focus:border-indigo-500 rounded-xl px-4 py-3 text-center text-lg font-bold text-slate-800 dark:text-white outline-none transition-all">
                
                <div class="relative">
                    <input type="password" id="passwordInput" placeholder="Sua Senha" 
                           class="w-full bg-slate-100 dark:bg-slate-800 border-2 border-transparent focus:border-indigo-500 rounded-xl px-4 py-3 text-center text-lg font-bold text-slate-800 dark:text-white outline-none transition-all">
                    <button onclick="togglePassword()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-indigo-600 transition-colors">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                </div>
            </div>

            <p id="loginMessage" class="text-red-500 text-[11px] font-bold mt-3 h-4 uppercase tracking-wider"></p>
            
            <button id="loginBtn" onclick="handleLogin()" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-xl shadow-xl transition-all uppercase tracking-widest">
                Abrir Bloco
            </button>
        </div>
    </div>

    <!-- App Principal -->
    <div id="mainApp" class="hidden h-full flex overflow-hidden">
        <aside class="w-72 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col shadow-xl z-20 transition-colors">
            <div class="p-6 bg-slate-900 dark:bg-black text-white">
                <h1 class="font-extrabold tracking-tighter text-2xl italic">LabNotes</h1>
                <p class="text-[9px] text-indigo-400 font-bold uppercase tracking-[0.2em] mt-1">Armazenamento Protegido</p>
            </div>
            
            <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-slate-50 dark:bg-slate-900/50">
                <span class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">Notas Privadas</span>
                <button onclick="createNewNote()" class="p-1.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-indigo-600 dark:text-indigo-400 rounded shadow-sm hover:bg-indigo-50 dark:hover:bg-slate-700 transition-colors">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                </button>
            </div>

            <div id="notesList" class="flex-1 overflow-y-auto p-4 space-y-1"></div>

            <button onclick="logout()" class="p-4 text-[10px] font-black text-slate-400 dark:text-slate-500 hover:text-red-500 dark:hover:text-red-400 text-center border-t border-slate-100 dark:border-slate-800 uppercase tracking-widest transition-colors">
                Trancar Bloco / Sair
            </button>
        </aside>

        <div class="flex-1 flex flex-col relative">
            <header class="h-16 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-8 z-10 transition-colors">
                <div class="flex items-center gap-4">
                    <div class="flex gap-1 bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                        <button onclick="format('bold')" class="w-8 h-8 flex items-center justify-center hover:bg-white dark:hover:bg-slate-700 rounded font-bold text-slate-700 dark:text-slate-300 transition-colors">B</button>
                        <button onclick="format('italic')" class="w-8 h-8 flex items-center justify-center hover:bg-white dark:hover:bg-slate-700 rounded italic text-slate-700 dark:text-slate-300 transition-colors">I</button>
                    </div>
                    <!-- Menu de Exportação Universal -->
                    <div class="h-8 w-[1px] bg-slate-200 dark:bg-slate-700 mx-2"></div>
                    <div class="flex gap-2">
                        <button onclick="downloadTXT()" title="Texto Simples" class="px-3 py-1.5 text-[10px] font-bold uppercase tracking-wider bg-slate-100 dark:bg-slate-800 hover:bg-indigo-600 hover:text-white rounded-lg transition-all">
                            TXT
                        </button>
                        <button onclick="downloadPDF()" title="Documento PDF" class="px-3 py-1.5 text-[10px] font-bold uppercase tracking-wider bg-slate-100 dark:bg-slate-800 hover:bg-indigo-600 hover:text-white rounded-lg transition-all">
                            PDF
                        </button>
                        <button onclick="downloadDOCX()" title="Microsoft Word" class="px-3 py-1.5 text-[10px] font-bold uppercase tracking-wider bg-slate-100 dark:bg-slate-800 hover:bg-indigo-600 hover:text-white rounded-lg transition-all">
                            DOCX
                        </button>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="toggleTheme()" class="p-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-all" title="Alternar Tema">
                        <svg class="dark:hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                        <svg class="hidden dark:block" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                    </button>

                    <button onclick="deleteNote()" class="p-2 text-slate-300 dark:text-slate-600 hover:text-red-500 dark:hover:text-red-400 transition-all">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6 md:p-10 bg-slate-50 dark:bg-slate-950 transition-colors">
                <div class="max-w-3xl mx-auto bg-white dark:bg-slate-900 min-h-[85vh] rounded-2xl shadow-2xl flex flex-col border border-slate-100 dark:border-slate-800 overflow-hidden transition-colors">
                    <input type="text" id="noteTitle" placeholder="Título da Nota..." 
                           class="w-full px-12 py-10 text-4xl font-black text-slate-800 dark:text-white bg-transparent outline-none border-b border-slate-50 dark:border-slate-800 focus:bg-slate-50/50 dark:focus:bg-slate-800/30 transition-all">
                    <div id="editor" class="editor-area flex-1 px-12 py-10 text-xl font-medium text-slate-700 dark:text-slate-300" contenteditable="true"></div>
                </div>
            </main>

            <footer class="h-10 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 px-8 flex items-center justify-end transition-colors">
                <div id="saveStatus" class="font-black uppercase tracking-widest text-slate-400 dark:text-slate-600 text-[9px] italic tracking-widest uppercase italic">Seguro</div>
            </footer>
        </div>
    </div>
</body>
</html>
